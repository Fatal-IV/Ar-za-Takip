<div id="admin" class="panel-section">
    <header class="top-bar">
        <h1>Arıza Yönetim Havuzu</h1>
    </header>
    
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterPool('all', this)">
            <span class="material-icons-round">dns</span>
            Tümü
        </button>
        <button class="filter-btn" onclick="filterPool('beklemede', this)">
            <span class="material-icons-round">hourglass_top</span>
            Bekleyenler
        </button>
        <button class="filter-btn" onclick="filterPool('atandi', this)">
            <span class="material-icons-round">assignment_ind</span>
            Atananlar
        </button>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <table class="operator-table">
            <thead>
                <tr>
                    <th style="padding-left: 24px;">Talep Eden</th>
                    <th>Arıza Özeti</th>
                    <th>Durum</th>
                    <th>İncele</th>
                    <th>Teknisyen Ata</th>
                    <th>İşlem</th> 
                    <% if(user.rol === 'admin') { %> 
                        <th style="text-align:center;">Sil</th> 
                    <% } %>
                </tr>
            </thead>
            <tbody>
                <% if(typeof allTickets !== 'undefined' && allTickets.length > 0) { %>
                    <% allTickets.forEach(t => { %>
                        <tr>
                            <td style="padding-left: 24px;">
                                <div class="user-meta">
                                    <div class="user-avatar-small">
                                        <%= t.ad.charAt(0) %><%= t.soyad.charAt(0) %>
                                    </div>
                                    <div class="meta-text">
                                        <div><%= t.ad %> <%= t.soyad %></div>
                                        <div><%= t.birim %></div>
                                    </div>
                                </div>
                            </td>

                            <td>
                                <div class="issue-title"><%= t.sorun_basligi %></div>
                                <div class="issue-desc">
                                    <%= t.detay.length > 40 ? t.detay.substring(0, 40) + '...' : t.detay %>
                                </div>
                                <div style="font-size:0.75rem; color:#5f6368; margin-top:4px;">
                                    <%= new Date(t.tarih).toLocaleString('tr-TR') %>
                                </div>
                            </td>

                            <td>
                                <span class="status-badge status-<%= t.durum %>">
                                    <%= t.durum.toUpperCase() %>
                                </span>
                            </td>
                            
                            <td>
                                <button class="btn-action" 
                                    style="width:auto; padding:8px; background:transparent; border:1px solid var(--border); color:var(--primary);"
                                    onclick="openTicketModal(<%= JSON.stringify(t) %>)"
                                    title="Detayları Gör">
                                    <span class="material-icons-round">visibility</span>
                                </button>
                            </td>

                            <td>
                                <% if(t.durum !== 'cozuldu') { %>
                                    <form action="/assign-ticket" method="POST" class="assign-wrapper">
                                        <input type="hidden" name="ticket_id" value="<%= t.id %>">
                                        <select name="teknisyen_id" class="tech-select" required>
                                            <option value="" disabled selected>Teknisyen Seç</option>
                                            <% technicians.forEach(tech => { %>
                                                <option value="<%= tech.id %>" <%= t.teknisyen_id === tech.id ? 'selected' : '' %>>
                                                    <%= tech.ad %> <%= tech.soyad %>
                                                </option>
                                            <% }) %>
                                        </select>
                                        <button type="submit" class="btn-assign" title="Ata">
                                            <span class="material-icons-round" style="font-size:18px;">arrow_forward</span>
                                        </button>
                                    </form>
                                <% } else { %>
                                    <div style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.9rem; font-weight:600; background:#e6f4ea; padding:6px 10px; border-radius:20px; width:fit-content; border:1px solid #ceead6;">
                                        <span class="material-icons-round" style="font-size:16px; color:var(--success);">verified</span> 
                                        <span style="color:#137333;">
                                            <%= t.tech_ad ? (t.tech_ad + ' ' + t.tech_soyad) : 'Tamamlandı' %>
                                        </span>
                                    </div>
                                <% } %>
                            </td>

                            <td>
                                <% if (t.durum === 'atandi' || t.durum === 'beklemede') { %>
                                    <form action="/resolve-ticket" method="POST">
                                        <input type="hidden" name="ticket_id" value="<%= t.id %>">
                                        <button type="submit" class="btn-action" style="background-color: #fff; border: 1px solid var(--success); color: var(--success); padding: 5px 10px;" title="Arızayı Çözüldü Olarak İşaretle">
                                            <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">check_circle</span>
                                            <span style="vertical-align: middle; font-size: 13px; font-weight: 600;">Onayla</span>
                                        </button>
                                    </form>
                                <% } else if (t.durum === 'cozuldu') { %>
                                    <span style="color: var(--success); font-size: 13px; font-weight: 600;">
                                        <span class="material-icons-round" style="font-size: 16px; vertical-align: bottom;">done_all</span>
                                    </span>
                                <% } else { %>
                                    <span style="color: var(--text-sub); font-size: 12px;">-</span>
                                <% } %>
                            </td>

                            <% if(user.rol === 'admin') { %>
                                <td style="text-align:center;">
                                    <form action="/delete-ticket" method="POST" onsubmit="return confirm('Bu kaydı kalıcı olarak silmek istediğinize emin misiniz?');">
                                        <input type="hidden" name="ticket_id" value="<%= t.id %>">
                                        <button type="submit" class="btn-delete" title="Kaydı Sil">
                                            <span class="material-icons-round">delete</span>
                                        </button>
                                    </form>
                                </td>
                            <% } %>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="<%= user.rol === 'admin' ? 7 : 6 %>" style="text-align:center; padding: 40px; color: var(--text-sub);">
                            <span class="material-icons-round" style="font-size: 48px; display:block; margin-bottom:10px; opacity:0.5;">inbox</span>
                            Şu an havuzda bekleyen arıza yok.
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<div id="ticketDetailModal" class="modal-overlay">
    <div class="modal-content">
        <div style="padding-top: 10px;">
            <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 20px;">
                <div class="input-group">
                    <input type="text" id="view_adsoyad" readonly placeholder=" ">
                    <label>Talep Eden</label>
                </div>
                <div class="input-group">
                    <input type="text" id="view_sicil" readonly placeholder=" ">
                    <label>Sicil No</label>
                </div>
            </div>

            <div class="form-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 20px;">
                 <div class="input-group">
                    <input type="text" id="view_birim" readonly placeholder=" ">
                    <label>Birim</label>
                </div>
                <div class="input-group">
                    <input type="text" id="view_tarih" readonly placeholder=" ">
                    <label>Tarih</label>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <input type="text" id="view_cihaz" readonly placeholder=" " style="color:#5f6368;">
                <label>Kayıt IP Adresi / Cihaz</label>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <input type="text" id="view_baslik" readonly placeholder=" ">
                <label>Sorun Başlığı</label>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <textarea id="view_detay" rows="5" readonly placeholder=" " style="resize:none;"></textarea>
                <label>Arıza Detayı</label>
            </div>
            
            <div class="input-group" style="display:flex; align-items:center; border-bottom:1px solid #ccc; margin-bottom: 20px;">
                <label style="position:static; transform:none; font-size:0.8rem; color:var(--text-sub); margin-right:10px;">Durum:</label>
                <span id="view_durum" class="status-badge" style="font-size: 0.85rem; padding: 4px 10px;"></span>
            </div>

            <button onclick="closeTicketModal()" class="btn-action" style="margin-top:10px;">
                <span class="material-icons-round">close</span>
                Pencereyi Kapat
            </button>
        </div>
    </div>
</div>

<style>
    /* Flexbox kullanarak modal'ı ekranın tam ortasına zorla */
    #ticketDetailModal.show {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }
    
    /* İçeriğin ekran dışına taşmasını engelle */
    #ticketDetailModal .modal-content {
        margin: auto;
        max-height: 90vh;
        overflow-y: auto;
    }
</style>