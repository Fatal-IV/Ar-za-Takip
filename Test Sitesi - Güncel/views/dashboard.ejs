<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Panel | Arıza Takip Sistemi</title>
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dashboard.css"> 
    <link rel="stylesheet" href="/css/sidebar.css">  
    <link rel="stylesheet" href="/css/operator.css"> 
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
    /* Filtre Butonları Hizalaması */
    .filter-bar .filter-btn {
        display: flex; /* İçeriği esnek kutu modeline çevirir */
        align-items: center; /* Dikeyde (yukarı-aşağı) tam ortalar */
        justify-content: center; /* Yatayda ortalar */
        gap: 8px; /* İkon ile yazı arasına 8px boşluk koyar */
        line-height: 1;
        padding: 10px 20px;          /* İç boşluk */
    }

    /* İkon boyutunu sabitleyelim ki yazıyı itmesin */
    .filter-bar .filter-btn .material-icons-round {
        font-size: 18px; /* İkon boyutu */
        margin: 0; /* Varsa dış boşlukları sıfırla */
    }
</style>
</head>
<body>

    <%- include('partials/sidebar') %>

    <main class="main-content">
        
        <div id="home" class="panel-section active">
            <header class="top-bar">
                <h1>Anasayfa</h1>
            </header>
            
        
            <div class="welcome-card">
                <div class="welcome-text">
                    <h2>Hoş Geldiniz, <%= user.ad %></h2>
                    <p>Sistemdeki güncel durumunuzu menüden takip edebilirsiniz.</p>
                </div>
             
                <div class="welcome-icon">
                    <span class="material-icons-round" style="font-size: 64px; color: var(--primary);">waving_hand</span>
                </div>
            </div>

            <% if (['operator', 'admin'].includes(user.rol)) { %>
                <% if (['teknisyen', 'operator', 'admin'].includes(user.rol)) { %>
                    <%- include('partials/quick-task-panel') %>
                <% } %>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="card" style="display:flex; align-items:center; gap:15px; padding:20px;">
                        <span class="material-icons-round" style="color:var(--danger); font-size:32px;">pending_actions</span>
                        <div>
                            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main);">Havuz</h3>
                            <p style="margin:0; font-size:0.85rem; color:var(--text-sub);">Atama Bekleyenler</p>
                        </div>
                    </div>
                    <div class="card" style="display:flex; align-items:center; gap:15px; padding:20px;">
                        <span class="material-icons-round" style="color:var(--warning); font-size:32px;">engineering</span>
                        <div>
                            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main);">Sahada</h3>
                            <p style="margin:0; font-size:0.85rem; color:var(--text-sub);">İşlemdekiler</p>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <div id="create" class="panel-section">
       
             <header class="top-bar">
                <h1>Yeni Arıza Kaydı</h1>
            </header>
            
            <div class="card">
                <form action="/create-ticket" method="POST">
                    <div class="input-group">
                        <input type="text" name="baslik" required placeholder=" ">
                        <label>Sorun Başlığı (Örn: Yazıcı Çıktı Vermiyor)</label>
                    </div>
                    
  
                    <div class="input-group">
                        <textarea name="detay" rows="5" required placeholder=" "></textarea>
                        <label>Detaylı Açıklama</label>
                    </div>
       
             
                    <button type="submit" class="btn-action">
                        <span class="material-icons-round">send</span>
                        Talebi Oluştur
               
                     </button>
                </form>
            </div>
        </div>

        <div id="my-tickets" class="panel-section">
            <header class="top-bar">
                <h1>Geçmiş Taleplerim</h1>
            </header>
       
             
            <div class="card" style="padding:0; overflow:hidden;">
                <table class="operator-table">
                    <thead>
                        <tr>
                            <th style="padding-left:24px;">Tarih</th>
          
                             <th>Konu / Detay</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
        
                     <tbody>
                        <% if(typeof myTickets !== 'undefined' && myTickets.length > 0) { %>
                            <% myTickets.forEach(t => { %>
                      
                                 <tr>
                                    <td style="padding-left:24px; font-size:0.9rem; color:var(--text-sub);">
                                        <%= new Date(t.tarih).toLocaleDateString('tr-TR') %>
        
                                     </td>
                                    <td>
                                    
                                         <div class="issue-title"><%= t.sorun_basligi %></div>
                                        <div class="issue-desc"><%= t.detay %></div>
                                    </td>
              
                                     <td><span class="status-badge status-<%= t.durum %>"><%= t.durum.toUpperCase() %></span></td>
                                </tr>
                            <% }) %>
          
                         <% } else { %>
                            <tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-sub);">Henüz bir talebiniz bulunmuyor.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <% if (['operator', 'admin'].includes(user.rol)) { %>
 
            <%- include('partials/operator-panel') %>
            <%- include('partials/stock-panel') %>
            <%- include('partials/quick-task-panel') %>
        <% } %>
       
        <% if (['teknisyen', 'admin'].includes(user.rol)) { %>
      
         <div id="tech-tasks" class="panel-section">
            <header class="top-bar">
                <h1><%= user.rol === 'admin' ? 'Tüm Saha Operasyonları' : 'Üzerimdeki Görevler' %></h1>
            </header>
            
            <div class="filter-bar" style="margin-bottom: 20px;">
                <button class="filter-btn active" onclick="filterTaskTable('all', this)">
                    <span class="material-icons-round" style="font-size:18px; margin-right:5px;">dns</span> Tümü
                </button>
                <button class="filter-btn" onclick="filterTaskTable('active', this)">
                    <span class="material-icons-round" style="font-size:18px; margin-right:5px;">hourglass_top</span> Bekleyenler
                </button>
                <button class="filter-btn" onclick="filterTaskTable('completed', this)">
                    <span class="material-icons-round" style="font-size:18px; margin-right:5px;">check_circle</span> Çözülenler
                </button>
            </div>

            <div class="card" style="padding:0; overflow:hidden;">
                <table class="operator-table" id="tech-tasks-table">
                  <thead>
                        <tr>
                            <th style="padding-left:24px;">Talep Eden</th>
          
                             <th>Arıza / İşlem</th>
                            <% if(user.rol === 'admin') { %> <th>Atanan Teknisyen</th> <% } %>
                            <th>Durum</th>
              
                             <th>İncele</th>
                            <th>Aksiyon</th>
                        </tr>
                  </thead>
                
                   <tbody>
                      <tr><td colspan="6" style="text-align:center; padding:30px;">Yükleniyor...</td></tr>
                  </tbody>
                </table>
            </div>
        </div>
        <% } %>
       
        <% if (user.rol === 'admin') { %>
            <%- include('partials/admin-users') %>
 
        <% } %>

  <div id="taskDetailModal" class="modal-overlay">
    <div class="modal-content dark-modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Arıza Detayları</h3>
            <button onclick="closeTaskDetailModal()" class="close-btn"><span class="material-icons-round">close</span></button>
        </div>
        
        <div style="padding-top: 15px;">
            
    
             <div class="form-grid-3" style="display:grid; grid-template-columns: 1fr 0.5fr 1fr; gap:15px; margin-bottom: 20px;">
                <div class="input-group dark-theme">
                    <input type="text" id="task_adsoyad" readonly placeholder=" ">
                    <label>Talep Eden</label>
                </div>
                <div class="input-group dark-theme">
 
                    <input type="text" id="task_sicil" readonly placeholder=" " style="font-family: monospace;">
                    <label>Sicil No</label>
                </div>
                <div class="input-group dark-theme">
                   
                     <input type="text" id="task_birim" readonly placeholder=" ">
                    <label>Birim</label>
                </div>
            </div>

            <div class="form-grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 20px;">
                <div class="input-group dark-theme">
                    <input type="text" id="task_baslik" readonly placeholder=" ">
                    <label>Sorun Başlığı</label>
                </div>
               
                 <div class="input-group dark-theme">
                    <input type="text" id="task_cihaz" readonly placeholder=" " style="color:var(--text-sub); font-size:0.85rem;">
                    <label>Kayıt Yapılan IP / Cihaz</label>
                </div>
            </div>

            <div class="input-group dark-theme" style="margin-bottom: 20px;">
                <input type="text" id="task_hizmet_yeri" readonly placeholder=" " style="font-weight: 500; color: var(--accent-blue, #8ab4f8);">
                <label>Hizmet Verilen Birim Bilgisi</label>
            </div>

            <div class="input-group dark-theme" style="margin-bottom: 20px;">
                <textarea id="task_detay" rows="6" readonly placeholder=" " style="resize:none; line-height:1.6;"></textarea>
                <label>Arıza Detayı</label>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid var(--border-color); padding-top:15px; margin-top:10px;">
                <div style="font-size: 0.85rem; color: var(--text-sub);">
                    <span class="material-icons-round" style="font-size:16px; vertical-align:text-bottom;">calendar_today</span>
                    <span id="task_tarih"></span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.85rem; color:var(--text-sub);">Durum:</span>
                    <span id="task_durum" class="status-badge"></span>
                </div>
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeTaskDetailModal()" class="btn-action primary-btn">
                    <span class="material-icons-round">done</span>
                    Tamam
                </button>
            </div>
        </div>
    
    </div>
</div>

    </main>
    <script>
        const currentUserRole = "<%= user.rol %>";
    </script>

    <script src="/js/dashboard.js"></script>
    <script src="/js/admin-logic.js"></script>
    <script src="/js/operator-logic.js"></script>
    <script src="/js/quick-task-logic.js"></script>
</body>
</html>